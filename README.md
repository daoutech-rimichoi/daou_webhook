# Daoutech Webhook Plugin

ë‹¤ìš°ê¸°ìˆ  ë ˆë“œë§ˆì¸ í™˜ê²½ì„ ìœ„í•œ Git ì›¹í›… ì—°ë™ í”ŒëŸ¬ê·¸ì¸ì…ë‹ˆë‹¤. Bitbucket Serverì˜ ì›¹í›…ì„ ìˆ˜ì‹ í•˜ì—¬ Push, Pull Request ì´ë²¤íŠ¸ë¥¼ ë ˆë“œë§ˆì¸ ì¼ê°ê³¼ ìë™ìœ¼ë¡œ ì—°ê³„í•©ë‹ˆë‹¤.

---

## ğŸ“‹ ì£¼ìš” ê¸°ëŠ¥

### 1. Git ì›¹í›… ìˆ˜ì‹  ë° ì²˜ë¦¬
- **Bitbucket Server ì›¹í›… ìˆ˜ì‹ **: `/git/webhooks` ì—”ë“œí¬ì¸íŠ¸ë¥¼ í†µí•´ Git ì´ë²¤íŠ¸ë¥¼ ìˆ˜ì‹ í•©ë‹ˆë‹¤.
- **ë‹¤ì–‘í•œ ì´ë²¤íŠ¸ ì§€ì›**:
    - `repo:refs_changed` - Push ì´ë²¤íŠ¸ (ë¸Œëœì¹˜ì— ì½”ë“œê°€ í‘¸ì‹œë  ë•Œ)
    - `pr:opened` - Pull Request ìƒì„±
    - `pr:merged` - Pull Request ë³‘í•©
    - `pr:declined` - Pull Request ê±°ë¶€
    - `pr:deleted` - Pull Request ì‚­ì œ

### 2. ì¼ê° ìë™ ì—°ê³„
ë¸Œëœì¹˜ëª…ì´ë‚˜ PR ì œëª©ì—ì„œ ì¼ê° ë²ˆí˜¸ë¥¼ ìë™ìœ¼ë¡œ ì¶”ì¶œí•˜ì—¬ ë ˆë“œë§ˆì¸ ì¼ê°ê³¼ ì—°ê³„í•©ë‹ˆë‹¤.

**ì§€ì›í•˜ëŠ” íŒ¨í„´:**
- `issue-123`, `issues-123` - ì¼ê° í‚¤ì›Œë“œ ì‚¬ìš©
- `task-456`, `tasks-456` - ì‘ì—… í‚¤ì›Œë“œ ì‚¬ìš©
- `issue-#123`, `issues-#123` - ì¼ê° í‚¤ì›Œë“œ + # ì‚¬ìš©
- `task-#456`, `tasks-#456` - ì‘ì—… í‚¤ì›Œë“œ + # ì‚¬ìš©
- `#123` - ë‹¨ë… # ë²ˆí˜¸ ì‚¬ìš©

**ë¸Œëœì¹˜ëª… ì˜ˆì‹œ:**
```
feature/issue-123-new-login
bugfix/task-456-fix-error
hotfix/#789-critical-bug
```

**PR ì œëª© ì˜ˆì‹œ:**
```
[issue-123] ë¡œê·¸ì¸ ê¸°ëŠ¥ ì¶”ê°€
[task-456] ë²„ê·¸ ìˆ˜ì •
#789 ê¸´ê¸‰ íŒ¨ì¹˜
```

### 3. Git ì´ë ¥ ì €ì¥ ë° ì¶”ì 
- ëª¨ë“  Git í™œë™ ì´ë ¥ì„ `git_histories` í…Œì´ë¸”ì— ì €ì¥í•©ë‹ˆë‹¤.
- ì €ì¥ì†Œ ì •ë³´, ë¸Œëœì¹˜, ì»¤ë°‹ í•´ì‹œ, ì‚¬ìš©ì ë“±ì˜ ìƒì„¸ ì •ë³´ë¥¼ í¬í•¨í•©ë‹ˆë‹¤.
- ë ˆë“œë§ˆì¸ì—ì„œ ì¼ê°ë³„ Git í™œë™ ì´ë ¥ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### 4. ì»¤ë°‹ ë° PR ë§í¬ ìë™ ìƒì„±
- Git Base URL ì„¤ì •ì„ í†µí•´ ì»¤ë°‹ ë° PR ìƒì„¸ í˜ì´ì§€ë¡œ ë°”ë¡œ ì´ë™í•  ìˆ˜ ìˆëŠ” ë§í¬ë¥¼ ìë™ ìƒì„±í•©ë‹ˆë‹¤.
- ì €ì¥ì†Œì˜ ì»¤ë°‹ í•´ì‹œì™€ PR ë²ˆí˜¸ë¥¼ í´ë¦­í•˜ë©´ Bitbucket í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.

---

## ğŸ›  í™˜ê²½ êµ¬ì„±

ë³¸ í”ŒëŸ¬ê·¸ì¸ì€ ì•„ë˜ í™˜ê²½ì—ì„œ ê°œë°œ ë° í…ŒìŠ¤íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.

- **OS**: Windows (Docker Desktop)
- **Docker Compose**: 2.40.3
- **Redmine**: 6.0.6
- **Ruby**: 3.2.9
- **Puma**: 7.0.1
- **Rails**: 7.2.2.1
- **Git Server**: Bitbucket Server

---

## ğŸ“¦ ì„¤ì¹˜ ë°©ë²•

### 1. í”ŒëŸ¬ê·¸ì¸ ë‹¤ìš´ë¡œë“œ
ë ˆë“œë§ˆì¸ì˜ `plugins` ë””ë ‰í† ë¦¬ë¡œ ì´ë™í•˜ì—¬ ì €ì¥ì†Œë¥¼ ë³µì œí•©ë‹ˆë‹¤.  
âš ï¸ **í´ë”ëª…ì€ ë°˜ë“œì‹œ `daou_webhook`ì´ì–´ì•¼ í•©ë‹ˆë‹¤.**

```bash
cd {REDMINE_ROOT}/plugins
git clone [repository_url] daou_webhook
```

### 2. ì˜ì¡´ì„± ì„¤ì¹˜
ë ˆë“œë§ˆì¸ ë£¨íŠ¸ ë””ë ‰í† ë¦¬ì—ì„œ ë²ˆë“¤ëŸ¬ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.

```bash
cd {REDMINE_ROOT}
bundle install --without development test
```

### 3. ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ (í•„ìˆ˜)
í”ŒëŸ¬ê·¸ì¸ ì „ìš© í…Œì´ë¸”(`git_histories`)ì„ ìƒì„±í•©ë‹ˆë‹¤.

```bash
bundle exec rake redmine:plugins:migrate NAME=daou_webhook RAILS_ENV=production
```

### 4. ì„œë²„ ì¬ì‹œì‘
ë³€ê²½ ì‚¬í•­ ì ìš©ì„ ìœ„í•´ ë ˆë“œë§ˆì¸ ì„œë²„ë¥¼ ì¬ì‹œì‘í•©ë‹ˆë‹¤.

```bash
# Apache/Passengerì˜ ê²½ìš°
touch tmp/restart.txt

# Puma/Unicornì˜ ê²½ìš°
sudo systemctl restart redmine

# Dockerì˜ ê²½ìš°
docker-compose restart redmine
```

---

## âš™ï¸ ë ˆë“œë§ˆì¸ ì„¤ì • ë°©ë²•

í”ŒëŸ¬ê·¸ì¸ ì„¤ì¹˜ í›„, ë ˆë“œë§ˆì¸ ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ Git Base URLì„ ì„¤ì •í•©ë‹ˆë‹¤.

### 1. ê´€ë¦¬ ë©”ë‰´ ì ‘ì†
ë ˆë“œë§ˆì¸ ìƒë‹¨ ë©”ë‰´ì—ì„œ **ê´€ë¦¬(Administration)** í´ë¦­

### 2. í”ŒëŸ¬ê·¸ì¸ ì„¤ì •
- ì¢Œì¸¡ ë©”ë‰´ì—ì„œ **í”ŒëŸ¬ê·¸ì¸(Plugins)** í´ë¦­
- **Daoutech Webhook Plugin** ì°¾ê¸°
- **ì„¤ì •(Configure)** ë²„íŠ¼ í´ë¦­

### 3. Git Base URL ì…ë ¥
- **Base URL** í•„ë“œì— Git ì„œë²„ ì£¼ì†Œ ì…ë ¥
- ì˜ˆì‹œ: `https://repo.daou.co.kr`
- **ì ìš©(Apply)** ë²„íŠ¼ í´ë¦­

> ğŸ’¡ ì´ ì„¤ì •ì„ í†µí•´ Git ì´ë ¥ì— í¬í•¨ëœ ì»¤ë°‹ê³¼ PR ë§í¬ê°€ ì˜¬ë°”ë¥¸ ì£¼ì†Œë¡œ ì—°ê²°ë©ë‹ˆë‹¤.

---

## ğŸ”— Bitbucket ì›¹í›… ì„¤ì • ë°©ë²•

ë ˆë“œë§ˆì¸ìœ¼ë¡œ Git ì´ë²¤íŠ¸ë¥¼ ì „ì†¡í•˜ë ¤ë©´ Bitbucket Serverì—ì„œ ì›¹í›…ì„ ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤.

### 1. Bitbucket ì €ì¥ì†Œ ì„¤ì • ì ‘ì†
1. Bitbucket Serverì— ë¡œê·¸ì¸
2. ì—°ë™í•  **í”„ë¡œì íŠ¸** ì„ íƒ
3. ì—°ë™í•  **ì €ì¥ì†Œ(Repository)** ì„ íƒ
4. ì¢Œì¸¡ ë©”ë‰´ì—ì„œ **Repository settings** í´ë¦­

### 2. ì›¹í›… ìƒì„±
1. ì¢Œì¸¡ ë©”ë‰´ì—ì„œ **Webhooks** ì„ íƒ
2. ìš°ì¸¡ ìƒë‹¨ì˜ **Create webhook** ë²„íŠ¼ í´ë¦­

### 3. ì›¹í›… ì •ë³´ ì…ë ¥

| í•­ëª© | ì…ë ¥ ê°’ |
|------|---------|
| **Name** | `Redmine Webhook` (ì›í•˜ëŠ” ì´ë¦„) |
| **URL** | `http://your-redmine-url/git/webhooks` ë˜ëŠ” `https://your-redmine-url/git/webhooks` |
| **Status** | **Active** ì„ íƒ (í™œì„±í™”) |

### 4. ì´ë²¤íŠ¸ ì„ íƒ
ë‹¤ìŒ ì´ë²¤íŠ¸ë“¤ì„ ì²´í¬í•©ë‹ˆë‹¤:

**Repository**
- â˜‘ Push

**Pull Request**
- â˜‘ Opened
- â˜‘ Merged
- â˜‘ Declined
- â˜‘ Deleted

### 5. ì €ì¥
**Save** ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì›¹í›…ì„ ìƒì„±í•©ë‹ˆë‹¤.

### 6. ì›¹í›… í…ŒìŠ¤íŠ¸ (ì„ íƒì‚¬í•­)
1. ìƒì„±ëœ ì›¹í›… ìš°ì¸¡ì˜ **...** ë©”ë‰´ í´ë¦­
2. **Test connection** ì„ íƒ
3. í…ŒìŠ¤íŠ¸ ê²°ê³¼ê°€ ì„±ê³µ(200 OK)ì¸ì§€ í™•ì¸

---

## âœ… ì›¹í›… ë™ì‘ í™•ì¸

ì›¹í›…ì´ ì •ìƒì ìœ¼ë¡œ ë™ì‘í•˜ëŠ”ì§€ í™•ì¸í•˜ëŠ” ë°©ë²•:

### 1. ì½”ë“œ Push í…ŒìŠ¤íŠ¸
```bash
# ë¸Œëœì¹˜ëª…ì— ì¼ê° ë²ˆí˜¸ë¥¼ í¬í•¨í•˜ì—¬ í‘¸ì‹œ
git checkout -b feature/issue-123-new-feature
git push origin feature/issue-123-new-feature
```
âœ… ë ˆë“œë§ˆì¸ ì¼ê° #123ì˜ í™œë™ ì´ë ¥ì— Git Push ê¸°ë¡ í™•ì¸

### 2. Pull Request í…ŒìŠ¤íŠ¸
- PR ì œëª©ì´ë‚˜ ì†ŒìŠ¤ ë¸Œëœì¹˜ì— ì¼ê° ë²ˆí˜¸ í¬í•¨
- PR ìƒì„±/ë³‘í•© í›„ ë ˆë“œë§ˆì¸ì—ì„œ í•´ë‹¹ ì¼ê°ì˜ Git ì´ë ¥ í™•ì¸

### 3. ë¡œê·¸ í™•ì¸
```bash
# ë ˆë“œë§ˆì¸ ë¡œê·¸ì—ì„œ ì›¹í›… ìˆ˜ì‹  ê¸°ë¡ í™•ì¸
tail -f {REDMINE_ROOT}/log/production.log | grep "Git webhook"
```

**ì„±ê³µ ë¡œê·¸ ì˜ˆì‹œ:**
```
Git webhook received: repo:refs_changed
Created git_history for push: ADD on feature/issue-123 (issue #123)
```

**ì‹¤íŒ¨ ë¡œê·¸ ì˜ˆì‹œ:**
```
Failed to create git_history for push: ADD on feature/issue-123. Errors: Notes can't be blank
```

---

## ğŸ—‘ ì‚­ì œ ë°©ë²•

### 1. ë°ì´í„°ë² ì´ìŠ¤ ë¡¤ë°±
í”ŒëŸ¬ê·¸ì¸ ì œê±° ì „, ìƒì„±ëœ í…Œì´ë¸”ì„ ì‚­ì œí•˜ê¸° ìœ„í•´ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ë¡¤ë°±í•©ë‹ˆë‹¤.

```bash
cd {REDMINE_ROOT}
bundle exec rake redmine:plugins:migrate NAME=daou_webhook VERSION=0 RAILS_ENV=production
```

### 2. ë””ë ‰í† ë¦¬ ì‚­ì œ
í”ŒëŸ¬ê·¸ì¸ ë””ë ‰í† ë¦¬ë¥¼ ì œê±°í•©ë‹ˆë‹¤.

```bash
rm -rf plugins/daou_webhook
```

### 3. ì„œë²„ ì¬ì‹œì‘
ì„œë²„ë¥¼ ì¬ì‹œì‘í•˜ì—¬ í”ŒëŸ¬ê·¸ì¸ì„ ì™„ì „íˆ ì œê±°í•©ë‹ˆë‹¤.

```bash
# Apache/Passengerì˜ ê²½ìš°
touch tmp/restart.txt

# Puma/Unicornì˜ ê²½ìš°
sudo systemctl restart redmine

# Dockerì˜ ê²½ìš°
docker-compose restart redmine
```

---

## ğŸ” ë¬¸ì œ í•´ê²°

### ì›¹í›…ì´ ìˆ˜ì‹ ë˜ì§€ ì•ŠëŠ” ê²½ìš°
1. âœ… Bitbucket ì›¹í›… ì„¤ì •ì—ì„œ URLì´ ì •í™•í•œì§€ í™•ì¸
2. âœ… ë°©í™”ë²½ì—ì„œ Bitbucket â†’ Redmine í†µì‹ ì´ í—ˆìš©ë˜ëŠ”ì§€ í™•ì¸
3. âœ… ë ˆë“œë§ˆì¸ ë¡œê·¸(`log/production.log`)ì—ì„œ ì—ëŸ¬ ë©”ì‹œì§€ í™•ì¸
4. âœ… Bitbucket ì›¹í›… í˜ì´ì§€ì—ì„œ Recent Deliveries í™•ì¸

### ì¼ê° ì—°ê³„ê°€ ì•ˆ ë˜ëŠ” ê²½ìš°
1. âœ… ë¸Œëœì¹˜ëª… í˜•ì‹ í™•ì¸
   - ì˜¬ë°”ë¥¸ ì˜ˆ: `feature/issue-123-description`, `bugfix/task-456-fix`, `hotfix/#789`
   - ì˜ëª»ëœ ì˜ˆ: `feature/123`, `bugfix/issue123`
2. âœ… PR ì œëª©ì— ì¼ê° ë²ˆí˜¸ í¬í•¨ ì—¬ë¶€ í™•ì¸
3. âœ… ì¼ê° ë²ˆí˜¸ê°€ ë ˆë“œë§ˆì¸ì— ì‹¤ì œë¡œ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
4. âœ… ë¡œê·¸ì—ì„œ `Created git_history` ë©”ì‹œì§€ í™•ì¸

### Git ì´ë ¥ì´ ì €ì¥ë˜ì§€ ì•ŠëŠ” ê²½ìš°
1. âœ… ë ˆë“œë§ˆì¸ ë¡œê·¸ì—ì„œ `Failed to create git_history` ì—ëŸ¬ í™•ì¸
2. âœ… `git_histories` í…Œì´ë¸”ì´ ì •ìƒì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸
3. âœ… ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ì´ ì™„ë£Œë˜ì—ˆëŠ”ì§€ í™•ì¸

---

## ğŸ“Œ ë²„ì „ ì •ë³´

- **í”ŒëŸ¬ê·¸ì¸ ë²„ì „**: 0.0.1
- **ì§€ì› Redmine ë²„ì „**: 6.0 ì´ìƒ (Redmine 6.X í…ŒìŠ¤íŠ¸ ì™„ë£Œ)

---

## ğŸ“ ë¼ì´ì„ ìŠ¤

Daoutech ë‚´ë¶€ ì‚¬ìš© ì „ìš©

